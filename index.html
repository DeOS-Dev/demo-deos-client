<!DOCTYPE html>
<html>
<head>
    <title>Deos Client Demo App</title>
    <style>
        .variable-pair {
          display: flex;
          gap: 10px;
          margin-top: 5px;
        }

        button {
            border: 1px solid #5b6672;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        button:focus {
            box-shadow: 0 0 5px rgba(81, 203, 238, 1);
        }

        #main-container{
            margin: 1rem;
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .flash {
            animation: flash 1.5s infinite;
        }

        @keyframes flash {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        #configInputs {
            background-color: #e1c1801c;
            border: 1px solid #5b6672;
            padding: 1rem;
            border-radius: 4px;
        }

        select {
            padding: 8px;
        }

      </style>
</head>
<body>
    <div id="main-container">
        <div id="app-options" style="
            display: flex;
            gap: 1rem;
        ">
            <div>
                <label for="dropdown">Select an app:</label>
                <select id="dropdown" name="dropdown">
                    <option value="Google Chrome">Google Chrome</option>
                    <option value="Google Chrome">Google Chrome</option>
                </select>
            </div>
            <div>
                <label for="turbo">Select a turbo:</label>
                <select id="turbo" name="turbo">
                    <option value="">Select turbo</option>
                </select>
            </div>
            <div>
                <button id="optionalParams">Add optional parameters</button>
            </div>
        </div>
        <div id="configInputs" style="display: none; gap: 1rem; position: relative;">
            <div>
                <h3>Environment variables</h3>
                <div id="envVariablesContainer">
                    <div class="variable-pair" style="height: 2rem;">
                        <label>Name:</label>
                        <input type="text" name="envName[]" class="env-name" placeholder="Enter name">
                        <label>Value:</label>
                        <input type="text" name="envValue[]" class="env-value" placeholder="Enter value">
                    </div>
                </div>
                <button id="addVariableButton" type="button" style="margin-top: 1rem;">Add Variable</button>
                
            </div>
            <div>
                <h3>Command to run</h3>
                <input style="height: 26px;" type="text" id="commandToRun" name="commandToRun" placeholder="Enter command to run">
            </div>
            <a id="documentationLink" href="#" target="_blank" style="position: absolute; bottom: 10px; right: 10px;">What are optional params?</a>         
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button id="fullscreen" onClick="requestFullScreen()">Fullscreen</button>
            <button id="instances" onClick="instances()">Show all instances</button>
            <button id="stopall" onClick="stopAll()">Stop all instances</button>
            <button id="quota" onClick="quota()">Show quota</button>
            <button id="stop" onClick="quit()">Stop running App</button>
            <button id="try" onClick="start()">Try App</button>
        </div>
        <div>
            <p id="status"></p>
        </div>
        <div id="iframe">
            
            <iframe id="iFrame" width="1200" height="640" frameborder="0" style="position:relative;z-index:100" allow="autoplay"></iframe>
        </div>
        
    </div>
    
</body>
<script type="module" src="config.js"></script>
<script type="module" src="dist/bundle.js"></script>
<script>
    const iframe = document.getElementById("iFrame");
    const fullscreenButton = document.getElementById("fullscreen");
    const statusText = document.getElementById("status");
    let app_instance = '';

    function removeOptionalParams() {
        const envVarsElement = document.getElementById('envVariablesContainer').querySelectorAll("div");
        const commandsElement = document.getElementById('commandToRun');

        for (let i = 0; i < envVarsElement.length; i++) {
            if (i === 0) {
                const firstDivInputs = envVarsElement[i].querySelectorAll("input");
                firstDivInputs.forEach(input => {
                    input.value = "";
                });
            } else {
                envVarsElement[i].remove();
            }
        }

        commandsElement.value = '';

    }

    document.getElementById('optionalParams').addEventListener('click', function() {
        const documentationLink = document.getElementById('documentationLink');
        const documentationUrl = 'https://' + window.endpoint + ".com/doc/docs/api/core/#launch";
        
        documentationLink.href = documentationUrl;
        
        var configInputs = document.getElementById('configInputs');
        var optionalParamsBtn = document.getElementById('optionalParams');

        configInputs.style.display = configInputs.style.display === 'none' ? 'flex' : 'none';
        if (optionalParamsBtn.innerText === 'Add optional parameters') {
            optionalParamsBtn.innerText = 'Remove optional parameters';
        } else {
            optionalParamsBtn.innerText = 'Add optional parameters';
            removeOptionalParams();
            
        }
    });

    document.getElementById('dropdown').addEventListener('change', function() {
        loadTurbos();
    });

    document.getElementById('addVariableButton').addEventListener('click', function() {
        const container = document.getElementById('envVariablesContainer');
        const variablePair = document.createElement('div');

        variablePair.className = 'variable-pair';
        const nameLabel = document.createElement('label');
        nameLabel.textContent = 'Name:';
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'env-name';
        nameInput.name = 'envName[]';
        nameInput.placeholder = 'Enter name';

        const valueLabel = document.createElement('label');
        valueLabel.textContent = 'Value:';
        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.name = 'envValue[]';
        valueInput.placeholder = 'Enter value';
        valueInput.className = 'env-value';

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = 'Remove';
        removeButton.addEventListener('click', function() {
            container.removeChild(variablePair);
        });

        variablePair.appendChild(nameLabel);
        variablePair.appendChild(nameInput);
        variablePair.appendChild(valueLabel);
        variablePair.appendChild(valueInput);
        variablePair.appendChild(removeButton);

        container.appendChild(variablePair);
    });

    window.addEventListener('message', (event) => {
        if (event.data.type === 'log') {
            console.log('Log from iframe:', event);
        }
    });

    window.addEventListener("DOMContentLoaded", () => {
        loadTurbos();
    });

    function requestFullScreen() {
        iframe.requestFullscreen();
        iframe.focus();
        navigator.keyboard.lock();
    }

    function getAppName() {
        const dropdown = document.getElementById("dropdown");
        return dropdown.value;
    }

    function getEnvironmentVariables() {
        const envVariables = [];
        const nameInputs = document.querySelectorAll('.env-name');
        const valueInputs = document.querySelectorAll('.env-value');

        nameInputs.forEach((nameInput, index) => {
        const valueInput = valueInputs[index];
        if (nameInput.value && valueInput.value) {
            envVariables.push({
            name: nameInput.value,
            value: valueInput.value
            });
        }
        });
        return envVariables;
    }

    function getCommandToRun() {
        const commandToRun = document.getElementById('commandToRun').value;
        return (commandToRun);
    }

    function getTurbo() {
        const turbo = document.getElementById("turbo");
        return turbo.value;
    }

    async function loadTurbos() {
        const app_name = getAppName();
        const turboData = await deos.turbos(app_name);
        const turboSelect = document.getElementById("turbo");

        // Reset turbo values
        turboSelect.innerHTML = '<option value="">Select turbo</option>';
        
        turboData.data.forEach(item => {
            const option = document.createElement("option");
            option.value = item.turbo_name;
            option.text = item.turbo_name;
            if (item.description) {
                option.text = item.turbo_name + ' - ' + item.description;
            }
            if (item.config_name === "DEFAULT") {
                option.selected = true;
            }
            turboSelect.appendChild(option);
        });
    }

    function quit() {
        deos.close(app_instance);
        app_instance = '';
        iframe.src = '';
        statusText.innerText = 'Thank you for trying the demo';
    }
    
    async function start() {
        const app_name = getAppName();
        const envVars = getEnvironmentVariables();
        const commandToRun = getCommandToRun();
        const turboName = getTurbo();

        statusText.classList.add("flash");
        statusText.innerText = 'Launching demo app: ' + app_name;
        let app;
        try {
            app = await deos.launch(app_name, app_instance, turboName, envVars, commandToRun);
            app_instance = app.instance;
            iframe.src = app.url;
            statusText.innerText = '';
        } catch (error) {
            statusText.innerText = error;
            if (app) deos.close(app.instance);
        } finally {
            statusText.classList.remove("flash");
        }
    }

    async function instances() {
        const app_name = getAppName();
        statusText.innerText = 'get instances for app: ' + app_name;
        try {
            const instances = await deos.instances(app_name);
            statusText.innerText = instances;
        } catch (error) {
            statusText.innerText = error;
        }
    }

    async function stopAll() {
        const app_name = getAppName();
        const instances = await deos.instances(app_name);
        instances.forEach( async (instance, index) => {
            statusText.innerText = 'stop instance: ' + instance;
            await deos.close(instance);
        });
    }

    async function quota() {
        const app_name = getAppName();
        const quotas = await deos.quota(app_name);
        statusText.innerText = 'instance quota for ' + app_name +   ': ' + quotas;
    }

</script>   
</html>